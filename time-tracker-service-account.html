<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Tracker - Google Sheets</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .setup-section {
            padding: 40px;
            max-width: 700px;
            margin: 0 auto;
        }

        .setup-section h2 {
            margin-bottom: 10px;
            color: #333;
        }

        .setup-section p {
            margin-bottom: 25px;
            color: #666;
            line-height: 1.6;
        }

        .setup-section .input-group {
            margin-bottom: 20px;
        }

        .setup-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .setup-section input,
        .setup-section textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            font-family: monospace;
        }

        .setup-section textarea {
            min-height: 200px;
            resize: vertical;
        }

        .setup-section input:focus,
        .setup-section textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .setup-section button {
            width: 100%;
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .setup-section button:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .setup-section .help-text {
            font-size: 14px;
            color: #999;
            margin-top: 8px;
        }

        .setup-section .example {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 13px;
            margin-top: 8px;
            word-break: break-all;
        }

        .main-content {
            display: none;
            padding: 30px;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: end;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .control-group input,
        .control-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .control-group input:focus,
        .control-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .control-group button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .control-group button:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        .control-group button.reset {
            background: #dc3545;
        }

        .control-group button.reset:hover {
            background: #c82333;
        }

        .activity-selector {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .activity-selector h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .activity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }

        .activity-button {
            padding: 12px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .activity-button:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateY(-2px);
        }

        .activity-button.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .activity-code {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .activity-name {
            font-size: 14px;
            opacity: 0.8;
        }

        .time-grid {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            overflow-x: auto;
        }

        .time-grid h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .grid-container {
            display: grid;
            grid-template-columns: 80px repeat(24, 60px);
            gap: 2px;
            background: white;
            border-radius: 8px;
            padding: 10px;
        }

        .grid-header {
            background: #667eea;
            color: white;
            padding: 8px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
            border-radius: 4px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .time-cell {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 12px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .time-cell:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .time-cell.filled {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .save-button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
        }

        .save-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .status {
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .info-box h4 {
            margin-bottom: 8px;
            color: #1976D2;
        }

        .info-box p {
            margin-bottom: 0;
            font-size: 14px;
            color: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚è∞ Time Tracker</h1>
            <p>Track your daily activities with Google Sheets (Service Account)</p>
        </div>

        <div class="setup-section" id="setupSection">
            <h2>Setup Your Tracker</h2>
            <p>Enter your Google Service Account credentials and spreadsheet ID. Your settings will be saved securely in your browser.</p>
            
            <div class="info-box">
                <h4>üîí Using Service Account Authentication</h4>
                <p>Service accounts provide secure, password-less access to your spreadsheet. You'll need to share your spreadsheet with the service account email address.</p>
            </div>

            <div class="input-group">
                <label for="serviceAccountInput">Service Account JSON Key</label>
                <textarea id="serviceAccountInput" placeholder='Paste your entire service account JSON here (from downloaded .json file)'></textarea>
                <div class="help-text">Download this from Google Cloud Console ‚Üí Service Accounts ‚Üí Create Key (JSON)</div>
            </div>

            <div class="input-group">
                <label for="spreadsheetIdInput">Your Spreadsheet ID</label>
                <input type="text" id="spreadsheetIdInput" placeholder="Enter your Google Sheets ID">
                <div class="help-text">
                    Find this in your spreadsheet URL:<br>
                    docs.google.com/spreadsheets/d/<strong>SPREADSHEET_ID</strong>/edit
                </div>
                <div class="example">Example: 13-jynghNoDEM_1HmI7EiXgXf7DwZ2UfFBrLVKM</div>
            </div>

            <button onclick="saveSettings()">
                Start Tracking
            </button>
        </div>

        <div class="main-content" id="mainContent">
            <div class="controls">
                <div class="control-group">
                    <label for="dateInput">Select Date</label>
                    <input type="date" id="dateInput">
                </div>
                <div class="control-group">
                    <button onclick="loadDayData()">Load Day</button>
                </div>
                <div class="control-group">
                    <button class="reset" onclick="resetSettings()">Change Settings</button>
                </div>
            </div>

            <div class="activity-selector">
                <h3>üìã Select Activity</h3>
                <div class="activity-grid" id="activityGrid"></div>
            </div>

            <div class="time-grid">
                <h3>üïê Fill Time Slots (Click to add selected activity)</h3>
                <div id="timeGridContainer"></div>
            </div>

            <button class="save-button" onclick="saveToSheet()">
                üíæ Save to Google Sheets
            </button>

            <div id="status"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsrsasign@10.5.25/lib/jsrsasign-all-min.js"></script>
    <script>
        let serviceAccountKey = null;
        let spreadsheetId = null;
        let accessToken = null;
        let tokenExpiry = null;
        let activities = [];
        let selectedActivity = null;
        let currentDate = null;
        let timeSlots = {};

        // Initialize on page load
        window.onload = function() {
            checkSavedSettings();
        };

        function checkSavedSettings() {
            const savedKey = localStorage.getItem('timeTrackerServiceKey');
            const savedSpreadsheetId = localStorage.getItem('timeTrackerSpreadsheetId');

            if (savedKey && savedSpreadsheetId) {
                try {
                    serviceAccountKey = JSON.parse(savedKey);
                    spreadsheetId = savedSpreadsheetId;
                    getAccessToken().then(() => {
                        showMainContent();
                    }).catch(err => {
                        showStatus('Error authenticating: ' + err.message, 'error');
                        document.getElementById('setupSection').style.display = 'block';
                    });
                } catch (err) {
                    document.getElementById('setupSection').style.display = 'block';
                }
            } else {
                document.getElementById('setupSection').style.display = 'block';
            }
        }

        function saveSettings() {
            const serviceAccountInput = document.getElementById('serviceAccountInput').value.trim();
            const spreadsheetIdInput = document.getElementById('spreadsheetIdInput').value.trim();

            if (!serviceAccountInput) {
                showStatus('Please paste your service account JSON', 'error');
                return;
            }

            if (!spreadsheetIdInput) {
                showStatus('Please enter your Spreadsheet ID', 'error');
                return;
            }

            try {
                serviceAccountKey = JSON.parse(serviceAccountInput);
                
                // Validate the JSON has required fields
                if (!serviceAccountKey.private_key || !serviceAccountKey.client_email) {
                    throw new Error('Invalid service account JSON - missing required fields');
                }

                spreadsheetId = spreadsheetIdInput;

                // Save to localStorage
                localStorage.setItem('timeTrackerServiceKey', JSON.stringify(serviceAccountKey));
                localStorage.setItem('timeTrackerSpreadsheetId', spreadsheetId);

                // Get access token and proceed
                getAccessToken().then(() => {
                    showMainContent();
                }).catch(err => {
                    showStatus('Error authenticating: ' + err.message, 'error');
                });

            } catch (err) {
                showStatus('Invalid JSON format: ' + err.message, 'error');
            }
        }

        function resetSettings() {
            if (confirm('This will clear your saved settings. Continue?')) {
                localStorage.removeItem('timeTrackerServiceKey');
                localStorage.removeItem('timeTrackerSpreadsheetId');
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('setupSection').style.display = 'block';
                document.getElementById('serviceAccountInput').value = '';
                document.getElementById('spreadsheetIdInput').value = '';
                serviceAccountKey = null;
                accessToken = null;
                tokenExpiry = null;
            }
        }

        async function getAccessToken() {
            // Check if token is still valid (with 5 minute buffer)
            if (accessToken && tokenExpiry && Date.now() < tokenExpiry - 300000) {
                return accessToken;
            }

            // Create JWT
            const now = Math.floor(Date.now() / 1000);
            const expiry = now + 3600; // 1 hour

            const header = {
                alg: 'RS256',
                typ: 'JWT'
            };

            const claim = {
                iss: serviceAccountKey.client_email,
                scope: 'https://www.googleapis.com/auth/spreadsheets',
                aud: 'https://oauth2.googleapis.com/token',
                iat: now,
                exp: expiry
            };

            // Sign JWT
            const sHeader = JSON.stringify(header);
            const sPayload = JSON.stringify(claim);
            const sJWT = KJUR.jws.JWS.sign('RS256', sHeader, sPayload, serviceAccountKey.private_key);

            // Exchange JWT for access token
            const response = await fetch('https://oauth2.googleapis.com/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    grant_type: 'urn:ietf:params:oauth:grant-type:jwt-bearer',
                    assertion: sJWT
                })
            });

            if (!response.ok) {
                throw new Error('Failed to get access token: ' + response.statusText);
            }

            const data = await response.json();
            accessToken = data.access_token;
            tokenExpiry = Date.now() + (data.expires_in * 1000);
            
            return accessToken;
        }

        async function showMainContent() {
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateInput').value = today;
            
            await loadActivities();
        }

        async function makeApiRequest(endpoint, options = {}) {
            await getAccessToken(); // Ensure token is valid

            const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${endpoint}`, {
                ...options,
                headers: {
                    ...options.headers,
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'API request failed');
            }

            return response.json();
        }

        async function loadActivities() {
            try {
                showStatus('Loading activities...', 'info');
                
                const data = await makeApiRequest(
                    `${spreadsheetId}/values/Categories!A2:D100`
                );

                const rows = data.values;
                if (!rows || rows.length === 0) {
                    showStatus('No activities found. Check your Categories sheet.', 'error');
                    return;
                }

                activities = rows.filter(row => row[0] && row[2]).map(row => ({
                    code: row[0],
                    activity: row[2],
                    comment: row[3] || ''
                }));

                renderActivityGrid();
                showStatus('Activities loaded successfully!', 'success');
                setTimeout(() => document.getElementById('status').innerHTML = '', 2000);
            } catch (err) {
                showStatus('Error loading activities: ' + err.message, 'error');
            }
        }

        function renderActivityGrid() {
            const grid = document.getElementById('activityGrid');
            grid.innerHTML = '';

            activities.forEach(activity => {
                const button = document.createElement('div');
                button.className = 'activity-button';
                button.innerHTML = `
                    <div class="activity-code">${activity.code}</div>
                    <div class="activity-name">${activity.activity}</div>
                `;
                button.onclick = () => selectActivity(activity, button);
                grid.appendChild(button);
            });
        }

        function selectActivity(activity, button) {
            document.querySelectorAll('.activity-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            button.classList.add('selected');
            selectedActivity = activity;
        }

        async function loadDayData() {
            const dateInput = document.getElementById('dateInput').value;
            if (!dateInput) {
                showStatus('Please select a date', 'error');
                return;
            }

            try {
                showStatus('Loading day data...', 'info');
                currentDate = new Date(dateInput + 'T00:00:00');
                
                const data = await makeApiRequest(
                    `${spreadsheetId}/values/Days!A2:CU500`
                );

                const rows = data.values || [];
                const dateStr = formatDate(currentDate);
                let rowData = null;

                for (let i = 0; i < rows.length; i++) {
                    if (rows[i][0] === dateStr) {
                        rowData = rows[i];
                        break;
                    }
                }

                timeSlots = {};
                if (rowData) {
                    for (let i = 2; i < rowData.length && i < 98; i++) {
                        const hour = Math.floor((i - 2) / 4);
                        const quarterIndex = (i - 2) % 4;
                        const key = `${hour}-${quarterIndex}`;
                        if (rowData[i]) {
                            timeSlots[key] = rowData[i];
                        }
                    }
                }

                renderTimeGrid();
                showStatus('Day data loaded!', 'success');
                setTimeout(() => document.getElementById('status').innerHTML = '', 2000);
            } catch (err) {
                showStatus('Error loading day data: ' + err.message, 'error');
            }
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return `${year}.${month}.${day}`;
        }

        function renderTimeGrid() {
            const container = document.getElementById('timeGridContainer');
            container.innerHTML = '';
            
            const gridContainer = document.createElement('div');
            gridContainer.className = 'grid-container';

            const hourHeader = document.createElement('div');
            hourHeader.className = 'grid-header';
            hourHeader.textContent = 'Hour';
            gridContainer.appendChild(hourHeader);

            for (let h = 0; h < 24; h++) {
                const header = document.createElement('div');
                header.className = 'grid-header';
                header.textContent = `${h}:00`;
                gridContainer.appendChild(header);
            }

            const minutes = ['00', '15', '30', '45'];
            
            for (let q = 0; q < 4; q++) {
                const minuteLabel = document.createElement('div');
                minuteLabel.className = 'grid-header';
                minuteLabel.textContent = `:${minutes[q]}`;
                gridContainer.appendChild(minuteLabel);

                for (let h = 0; h < 24; h++) {
                    const cell = document.createElement('div');
                    cell.className = 'time-cell';
                    const key = `${h}-${q}`;
                    
                    if (timeSlots[key]) {
                        cell.textContent = timeSlots[key];
                        cell.classList.add('filled');
                    }
                    
                    cell.onclick = () => fillTimeSlot(h, q, cell);
                    gridContainer.appendChild(cell);
                }
            }

            container.appendChild(gridContainer);
        }

        function fillTimeSlot(hour, quarter, cell) {
            if (!selectedActivity) {
                showStatus('Please select an activity first', 'error');
                setTimeout(() => document.getElementById('status').innerHTML = '', 2000);
                return;
            }

            const key = `${hour}-${quarter}`;
            
            if (timeSlots[key] === selectedActivity.code) {
                delete timeSlots[key];
                cell.textContent = '';
                cell.classList.remove('filled');
            } else {
                timeSlots[key] = selectedActivity.code;
                cell.textContent = selectedActivity.code;
                cell.classList.add('filled');
            }
        }

        async function saveToSheet() {
            if (!currentDate) {
                showStatus('Please load a day first', 'error');
                return;
            }

            try {
                showStatus('Saving to Google Sheets...', 'info');

                const data = await makeApiRequest(
                    `${spreadsheetId}/values/Days!A2:B500`
                );

                const rows = data.values || [];
                const dateStr = formatDate(currentDate);
                let rowIndex = -1;

                for (let i = 0; i < rows.length; i++) {
                    if (rows[i][0] === dateStr) {
                        rowIndex = i + 2;
                        break;
                    }
                }

                if (rowIndex === -1) {
                    showStatus('Date not found in sheet. Please ensure the date exists in the Days sheet.', 'error');
                    return;
                }

                const values = [];
                for (let h = 0; h < 24; h++) {
                    for (let q = 0; q < 4; q++) {
                        const key = `${h}-${q}`;
                        values.push(timeSlots[key] || '');
                    }
                }

                await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/Days!C${rowIndex}:CU${rowIndex}?valueInputOption=RAW`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        values: [values]
                    })
                });

                showStatus('‚úÖ Saved successfully to Google Sheets!', 'success');
            } catch (err) {
                showStatus('Error saving: ' + err.message, 'error');
            }
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.innerHTML = message;
            status.className = `status ${type}`;
            status.classList.remove('hidden');
        }
    </script>
</body>
</html>
